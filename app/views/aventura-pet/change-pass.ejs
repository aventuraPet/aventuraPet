<section class="configure-section">
    <div class="configure-container">
        <div class="section-header">
            <h1 class="section-title">ALTERAR SENHA</h1>
            <div class="section-divider"></div>
        </div>

        <div class="configure-content">
            <div class="configure-card">
                <div class="card-header">
                    <i class="fas fa-key card-icon"></i>
                    <h3>Verificação de Segurança</h3>
                </div>

                <div class="configure-form">
                    <div class="form-group">
                        <label for="pass-now">
                            <i class="fas fa-lock"></i>
                            SENHA ATUAL
                        </label>
                        <input type="password" name="pass-now" id="pass-now" placeholder="Digite sua senha atual" required>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="verificar" class="submit-btn">
                            <i class="fas fa-check"></i>
                            Verificar
                        </button>
                        <a href="/aventura-pet/configure" class="btn secondary">
                            <i class="fas fa-arrow-left"></i>
                            Voltar
                        </a>
                    </div>

                    <form id="form-change-pass" class="change-pass-form">
                        <div class="warning-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Atenção:</strong> A nova senha deve ter pelo menos 8 caracteres, incluindo maiúscula, minúscula, número e símbolo especial.
                        </div>
                        <!-- Campos dinâmicos serão inseridos aqui -->
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    document.addEventListener("DOMContentLoaded", function(){
        var verificar = document.getElementById("verificar");
        verificar.addEventListener("click", function(){
            var form = document.getElementById("form-change-pass");
            var pass_now = document.getElementById("pass-now");
            fetch('/aventura-pet/change-pass',{
                method: 'post',
                headers:{
                    "Content-Type": "application/json"
                },
                body:JSON.stringify({
                    password: pass_now.value
                })
            })
            .then(response => response.json())
            .then(data =>{
                if(!data.status){
                    
                    var elementMsg = document.createElement("p");
                    elementMsg.setAttribute("class", "msgError");
                    elementMsg.textContent = data.msg;
                    form.appendChild(elementMsg);
                }

            

                var responsePassOne = data.body.passOne;
                var responsePassTwo = data.body.passTwo;
                var responseButton = data.body.button;

                var passwordOne = document.createElement(responsePassOne.element);
                var passwordTwo = document.createElement(responsePassTwo.element);
                var button = document.createElement(responseButton.element);
                
                passwordOne.setAttribute("type", responsePassOne.type);
                passwordOne.setAttribute("name", responsePassOne.name);
                passwordOne.setAttribute("id", responsePassOne.id);
                if (responsePassOne.placeholder) {
                    passwordOne.setAttribute("placeholder", responsePassOne.placeholder);
                }

                passwordTwo.setAttribute("type", responsePassTwo.type);
                passwordTwo.setAttribute("name", responsePassTwo.name);
                passwordTwo.setAttribute("id", responsePassTwo.id);
                if (responsePassTwo.placeholder) {
                    passwordTwo.setAttribute("placeholder", responsePassTwo.placeholder);
                }

                button.setAttribute('type', responseButton.type);
                button.setAttribute('value', responseButton.value);

               
                form.appendChild(passwordOne);
                form.appendChild(passwordTwo);
                form.appendChild(button);
            })
            .catch(error => {
                console.error("erro na requisição", error);
            })
        });

        document.getElementById("form-change-pass").addEventListener("submit", async function(form){
            form.preventDefault();
            var formulario = document.getElementById("form-change-pass");
            var errorDiv = document.createElement("div");
            let isValid = "";
            const password = formulario.querySelector("#passwordOne").value;
            const verifyPassword = formulario.querySelector("#passwordTwo").value;
            if(password.length < 8 || !/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_])/.test(password)){
                errorDiv.textContent = "Senha deve ter pelo menos 8 caracteres, incluindo maiúscula, minúscula, número e símbolo.";
                isValid = false;
            }else if(password !== verifyPassword){
                errorDiv.textContent = "senha nao conicidem";
                isValid = false;
            }else{
                isValid = true;
            }
            
            if(isValid){
                await fetch("/aventura-pet/new-pass", {
                    method:"post",
                    headers:{ "Content-Type": "application/json"},
                    body: JSON.stringify({password, verifyPassword})
                })
                .then(response => {
                    if(response.ok){
                        fetch("/login/logout");
                        location.reload(true);
                    }else{
                        errorDiv.textContent = "nao foi possivel alterar a senha tente novamente";
                        formulario.appendChild(errorDiv);
                    }
                })
               
            }
        });
    });
</script>
